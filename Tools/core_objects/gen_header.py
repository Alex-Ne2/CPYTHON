
import sys

HEADER = """/* This file generated by Tools/core_objects/gen_header.py */
#ifndef _PY_CORE_OBJECTS_H
#define _PY_CORE_OBJECTS_H

#include "Python.h"

#define _Py_ID(name) ((PyObject *)&_Py_id_strings.id_##name)

"""

def print_struct(length):
    print(f"""
typedef struct _ascii_{length} {{
    PyASCIIObject object;
    char text[{length}];
}} _PyAsciiId_{length};
""")

def main(idsfile="identifiers.txt"):
    print(HEADER)
    with open(idsfile) as fd:
        identifiers = [line.strip() for line in fd if line.strip()]
    lens = { (len(id)+4) & -4 for id in identifiers }
    for length in lens:
        print_struct(length)
    print("typedef struct _py_id_strings {")
    for name in identifiers:
        length = (len(name)+4) & -4
        print(f"    _PyAsciiId_{length} id_{name};")
    print("} _PyIdStrings;")
    print()
    print("PyAPI_DATA(_PyIdStrings) _Py_id_strings;")
    print("extern void _Py_intern_identifiers(void);")

    print('#endif // _PY_CORE_OBJECTS_H')

if __name__ == '__main__':
    main(sys.argv[1])
