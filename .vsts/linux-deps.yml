parameters:
  OPENSSL: 1.1.0g
  OPENSSL_DIR: "$HOME/multissl/openssl/$(OPENSSL)"

steps:
- script: echo "deb-src http://archive.ubuntu.com/ubuntu/ xenial main" > /etc/apt/sources.list.d/python.list && sudo apt-get update
  displayName: 'Update apt-get lists'

- script: echo ##vso[task.prependpath]$(OPENSSL_DIR)
  displayName: 'Add $(OPENSSL_DIR) to PATH'
- script: >
    sudo apt-get -yq install
    build-essential
    zlib1g-dev
    libbz2-dev
    liblzma-dev
    libncurses5-dev
    libreadline6-dev
    libsqlite3-dev
    libssl-dev
    libgdbm-dev
    tk-dev
    lzma
    lzma-dev
    liblzma-dev
    libffi-dev
    uuid-dev
  displayName: 'apt-get install uuid-dev'
- script: python3 Tools/ssl/multissltests.py --steps=library --base-directory $HOME/multissl --openssl $(OPENSSL)
  displayName: 'python multissltests.py'
  env:
    # Use -O3 because we don't use debugger on Travis-CI
    CFLAGS: "-I$(OPENSSL_DIR)/include -O3"
    LDFLAGS: "-L$(OPENSSL_DIR)/lib"
    # Set rpath with env var instead of -Wl,-rpath linker flag
    # OpenSSL ignores LDFLAGS when linking bin/openssl
    LD_RUN_PATH: "$(OPENSSL_DIR)/lib"
