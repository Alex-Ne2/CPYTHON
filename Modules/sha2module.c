/* SHA2 module */

/* This provides an interface to NIST's SHA2 224, 256, 384, & 512 Algorithms */

/* See below for information about the original code this module was
   based upon. Additional work performed by:

   Andrew Kuchling (amk@amk.ca)
   Greg Stein (gstein@lyra.org)
   Trevor Perrin (trevp@trevp.net)
   Jonathan Protzenko (jonathan@protzenko.fr)
   Bénédikt Tran (10796600+picnixz@users.noreply.github.com)

   Copyright (C) 2005-2007   Gregory P. Smith (greg@krypto.org)
   Licensed to PSF under a Contributor Agreement.

*/

/* SHA objects */
#ifndef Py_BUILD_CORE_BUILTIN
#  define Py_BUILD_CORE_MODULE 1
#endif

#include "Python.h"
#include "pycore_moduleobject.h"    // _PyModule_GetState()
#include "pycore_strhex.h"          // _Py_strhex()
#include "pycore_typeobject.h"      // _PyType_GetModuleState()

#include "hashlib.h"

#include "_hacl/Hacl_Hash_SHA2.h"

/*
 * Call a macro with all SHA-2 known digest sizes.
 *
 * The macro MACRO takes as input a SHA-2 digest size
 * and produces *syntactally correct* code.
 */
#define SHA2_EXPAND_MACRO(MACRO)    \
    MACRO(224);                     \
    MACRO(256);                     \
    MACRO(384);                     \
    MACRO(512);

/* The name of an HACL* SHA-2 routine. */
#define HACL_HASH_SHA2_(N, NAME)    Hacl_Hash_SHA2_ ## NAME ## _ ## N

/* The state attribute name holding the corresponding (PyTypeObject *). */
#define SHA2N_T(N)                  sha ## N ## _type
/* The name of the structure used to represent SHA-2 objects. */
#define SHA2N_O(N)                  SHA ## N ## object

/* Name of a local (static) helper acting on Python objects. */
#define SHA2N_HELPER(N, NAME)       sha ## N ## _ ## NAME
/* Name of a local (static) helper acting on HACL* objects. */
#define SHA2N_HACL_HELPER(N, NAME)  hacl_sha ## N ## _ ## NAME

/* Name of a SHA-2 object getter. */
#define SHA2N_GETTER(N, NAME)       _sha2_sha ## N ## _ ## NAME ## _get
/* Name of a SHA-2 object method generated by Argument Clinic. */
#define SHA2N_CLINIC(N, NAME)       _SHA2_SHA ## N ## _ ## NAME

/* The function implementing a SHA-2 type slot. */
#define SHA2N_TYPE_SLOT(N, NAME)    SHA ## N ## object_ ## NAME
/* The name of the array holding the different SHA-2 type slots. */
#define SHA2N_TYPE_SLOT_ARRAY(N)    SHA ## N ## _type_slots
/* The name of the global variable holding the SHA-2 type spec. */
#define SHA2N_TYPE_SPEC(N)          SHA ## N ## _type_spec

/* The SHA-2 block sizes and maximum message digest sizes, in bytes. */

#define SHA224_BLOCK_SIZE       64U
#define SHA224_DIGEST_SIZE      28U

#define SHA256_BLOCK_SIZE       64U
#define SHA256_DIGEST_SIZE      32U

#define SHA384_BLOCK_SIZE       128U
#define SHA384_DIGEST_SIZE      48U

#define SHA512_BLOCK_SIZE       128U
#define SHA512_DIGEST_SIZE      64U

#define SHA2N_BLOCK_SIZE(N)     SHA ## N ## _ ## BLOCK_SIZE
#define SHA2N_DIGEST_SIZE(N)    SHA ## N ## _ ## DIGEST_SIZE

// --- SHA-2 module state -----------------------------------------------------

typedef struct {
#define SHA2N_TYPE_DECL(N)  PyTypeObject *SHA2N_T(N)
    SHA2_EXPAND_MACRO(SHA2N_TYPE_DECL)
#undef SHA2N_TYPE_DECL
} sha2module_state;

static inline sha2module_state *
get_sha2module_state(PyObject *module)
{
    void *state = _PyModule_GetState(module);
    assert(state != NULL);
    return (sha2module_state *)state;
}

static inline sha2module_state *
get_sha2module_state_by_cls(PyTypeObject *cls)
{
    // _PyType_GetModuleState() is safe because the SHA-2 types are final.
    void *state = _PyType_GetModuleState(cls);
    assert(state != NULL);
    return (sha2module_state *)state;
}

// --- SHA-2 object -----------------------------------------------------------

#define SHA2N_OBJECT_STRUCT_DECL(N)             \
    typedef struct {                            \
        HASHLIB_OBJECT_HEAD                     \
        Hacl_Hash_SHA2_state_t_ ## N *state;    \
    } SHA2N_O(N);
SHA2_EXPAND_MACRO(SHA2N_OBJECT_STRUCT_DECL)
#undef SHA2N_OBJECT_STRUCT_DECL

#define SHA2object_CAST(N, op)  ((SHA2N_O(N) *)(op))

/*
 * HACL* does not provide a copy function for SHA-224 and SHA-384
 * as their state is the *same* as for SHA-256 and SHA-512, so we
 * provide those missing aliases (which must be prefixed with the
 * namespace we chose in Modules/_hacl/python_hacl_namespaces.h).
 *
 * Note: do not use HACL_HASH_SHA2_([256,512], copy) since
 * double macro expansion is not supported by C compilers.
 */
#define Hacl_Hash_SHA2_copy_224 Hacl_Hash_SHA2_copy_256
#define Hacl_Hash_SHA2_copy_384 Hacl_Hash_SHA2_copy_512

// --- SHA-2 module clinic configuration --------------------------------------

/*[clinic input]
module _sha2
class _sha2.sha224  "SHA2N_O(224) *"    "clinic_state()->SHA2N_T(224)"
class _sha2.sha256  "SHA2N_O(256) *"    "clinic_state()->SHA2N_T(256)"
class _sha2.sha384  "SHA2N_O(384) *"    "clinic_state()->SHA2N_T(384)"
class _sha2.sha512  "SHA2N_O(512) *"    "clinic_state()->SHA2N_T(512)"
[clinic start generated code]*/
/*[clinic end generated code: output=da39a3ee5e6b4b0d input=c3e4bea8800f0fd0]*/

#define clinic_state()  (get_sha2module_state_by_cls(Py_TYPE(self)))
#include "clinic/sha2module.c.h"
#undef clinic_state

// --- SHA-2 object: special methods ------------------------------------------

static int
SHA2object_traverse(PyObject *op, visitproc visit, void *arg)
{
    Py_VISIT(Py_TYPE(op));
    return 0;
}

#define SHA224object_traverse SHA2object_traverse
#define SHA256object_traverse SHA2object_traverse
#define SHA384object_traverse SHA2object_traverse
#define SHA512object_traverse SHA2object_traverse

#define SHA2N_OBJECT_DEALLOC_DECL(N)            \
static void                                     \
SHA2N_TYPE_SLOT(N, dealloc) (PyObject *op)      \
{                                               \
    SHA2N_O(N) *self = SHA2object_CAST(N, op);  \
    if (self->state != NULL) {                  \
        HACL_HASH_SHA2_(N, free)(self->state);  \
        self->state = NULL;                     \
    }                                           \
    PyTypeObject *tp = Py_TYPE(self);           \
    PyObject_GC_UnTrack(self);                  \
    PyObject_GC_Del(self);                      \
    Py_DECREF(tp);                              \
}
SHA2_EXPAND_MACRO(SHA2N_OBJECT_DEALLOC_DECL)
#undef SHA2N_OBJECT_DEALLOC_DECL

// --- SHA-2 object: helpers --------------------------------------------------

/* Allocate memory for a new SHA-2 object and initialize its attributes. */
#define SHA2N_OBJECT_NEW_DECL(N)                                            \
    static SHA2N_O(N) *                                                     \
    SHA2N_HELPER(N, new) (sha2module_state *state)                          \
    {                                                                       \
        SHA2N_O(N) *self = PyObject_GC_New(SHA2N_O(N), state->SHA2N_T(N));  \
        if (self == NULL) {                                                 \
            return NULL;                                                    \
        }                                                                   \
        HASHLIB_INIT_MUTEX(self);                                           \
        PyObject_GC_Track(self);                                            \
        return self;                                                        \
    }
SHA2_EXPAND_MACRO(SHA2N_OBJECT_NEW_DECL)
#undef SHA2N_OBJECT_NEW_DECL

// --- SHA-2 object: public methods -------------------------------------------

#define SHA2N_OBJECT_COPY_UNLOCKED_DECL(N)                              \
    static int                                                          \
    SHA2N_HELPER(N, copy_unlocked) (SHA2N_O(N) *src, SHA2N_O(N) *dst)   \
    {                                                                   \
        dst->state = HACL_HASH_SHA2_(N, copy)(src->state);              \
        if (dst->state == NULL) {                                       \
            (void)PyErr_NoMemory();                                     \
            return -1;                                                  \
        }                                                               \
        return 0;                                                       \
    }
SHA2_EXPAND_MACRO(SHA2N_OBJECT_COPY_UNLOCKED_DECL)
#undef SHA2N_OBJECT_COPY_UNLOCKED_DECL

#define SHA2N_OBJECT_COPY_IMPL_BODY(N, SELF)                        \
    {                                                               \
        PyTypeObject *cls = Py_TYPE(SELF);                          \
        sha2module_state *state = get_sha2module_state_by_cls(cls); \
        SHA2N_O(N) *copy = SHA2N_HELPER(N, new)(state);             \
        if (copy == NULL) {                                         \
            return NULL;                                            \
        }                                                           \
        int rc;                                                     \
        HASHLIB_ACQUIRE_LOCK(SELF);                                 \
        rc = SHA2N_HELPER(N, copy_unlocked)(SELF, copy);            \
        HASHLIB_RELEASE_LOCK(SELF);                                 \
        if (rc < 0) {                                               \
            Py_DECREF(copy);                                        \
            return NULL;                                            \
        }                                                           \
        return (PyObject *)copy;                                    \
    }

/*[clinic input]
_sha2.sha224.copy
Return a copy of the hash object.
[clinic start generated code]*/

static PyObject *
_sha2_sha224_copy_impl(SHA2N_O(224) *self)
/*[clinic end generated code: output=15b659d696b1a0ba input=7162c33cbb88084e]*/
SHA2N_OBJECT_COPY_IMPL_BODY(224, self)

/*[clinic input]
_sha2.sha256.copy
Return a copy of the hash object.
[clinic start generated code]*/

static PyObject *
_sha2_sha256_copy_impl(SHA2N_O(256) *self)
/*[clinic end generated code: output=320dfb9aee48bf50 input=6c05ad66f876c316]*/
SHA2N_OBJECT_COPY_IMPL_BODY(256, self)

/*[clinic input]
_sha2.sha384.copy
Return a copy of the hash object.
[clinic start generated code]*/

static PyObject *
_sha2_sha384_copy_impl(SHA2N_O(384) *self)
/*[clinic end generated code: output=77e81007d40cae4b input=c23c134ce53c0465]*/
SHA2N_OBJECT_COPY_IMPL_BODY(384, self)

/*[clinic input]
_sha2.sha512.copy
Return a copy of the hash object.
[clinic start generated code]*/

static PyObject *
_sha2_sha512_copy_impl(SHA2N_O(512) *self)
/*[clinic end generated code: output=77dfbe2b79137553 input=076f685299a203a6]*/
SHA2N_OBJECT_COPY_IMPL_BODY(512, self)
#undef SHA2N_OBJECT_COPY_IMPL_BODY

// The hacl_sha{224,256,384,512}_state_update() functions below ignore
// the error code returned by Hacl_Hash_SHA2_update_{224,256,384,512}()
// on the basis that it would take more than 1 billion years to overflow
// the maximum admissible lengths for SHA-2/{224,256} and SHA-2/{384,512},
// which are (2^61-1) and (2^64-1) respectively.
#if PY_SSIZE_T_MAX > UINT32_MAX
#define SHA2N_HACL_SHA2_STATE_UPDATE_DECL(N)                                \
    /*
     * HACL* takes a uint32_t for the length of its parameter,
     * but Py_ssize_t can be 64 bits so we loop in <4gig chunks
     * when needed.
     */                                                                     \
    static void                                                             \
    SHA2N_HACL_HELPER(N, state_update) (HACL_HASH_SHA2_(N, state_t) *state, \
                                        uint8_t *buf, Py_ssize_t len)       \
    {                                                                       \
         while (len > UINT32_MAX) {                                         \
            (void)HACL_HASH_SHA2_(N, update)(state, buf, UINT32_MAX);       \
            len -= UINT32_MAX;                                              \
            buf += UINT32_MAX;                                              \
        }                                                                   \
        /* cast to uint32_t is now safe */                                  \
        (void)HACL_HASH_SHA2_(N, update)(state, buf, (uint32_t)len);        \
    }
#else
#define SHA2N_HACL_SHA2_STATE_UPDATE_DECL(N)                                \
    static inline void                                                      \
    SHA2N_HACL_HELPER(N, state_update) (HACL_HASH_SHA2_(N, state_t) *state, \
                                        uint8_t *buf, Py_ssize_t len)       \
    {                                                                       \
        (void)HACL_HASH_SHA2_(N, update)(state, buf, (uint32_t)len);        \
    }
#endif
SHA2_EXPAND_MACRO(SHA2N_HACL_SHA2_STATE_UPDATE_DECL)
#undef SHA2N_HACL_SHA2_STATE_UPDATE_DECL

#define SHA2N_HACL_SHA2_STATE_UPDATE_WITH_BUFFER(N, SELF, BUF)              \
    SHA2N_HACL_HELPER(N, state_update)((SELF)->state, (BUF).buf, (BUF).len)

#define SHA2N_OBJECT_UPDATE_IMPL_BODY(N, OP, MSG)                   \
    {                                                               \
        Py_buffer buf;                                              \
        SHA2N_O(N) *self = SHA2object_CAST(N, (OP));                \
        GET_BUFFER_VIEW_OR_ERROUT((MSG), &buf);                     \
        HASHLIB_EXTERNAL_INSTRUCTIONS_LOCKED(                       \
            self, buf.len,                                          \
            SHA2N_HACL_SHA2_STATE_UPDATE_WITH_BUFFER(N, self, buf)  \
        );                                                          \
        PyBuffer_Release(&buf);                                     \
        Py_RETURN_NONE;                                             \
    }

/*[clinic input]
_sha2.sha224.update

    op: self
    data: object
    /

Update this hash object's state with the provided string.
[clinic start generated code]*/

static PyObject *
_sha2_sha224_update(PyObject *op, PyObject *data)
/*[clinic end generated code: output=234ae9a31416039f input=3d0c176d74dd455f]*/
SHA2N_OBJECT_UPDATE_IMPL_BODY(224, op, data)

/*[clinic input]
_sha2.sha256.update = _sha2.sha224.update
Update this hash object's state with the provided string.
[clinic start generated code]*/

static PyObject *
_sha2_sha256_update(PyObject *op, PyObject *data)
/*[clinic end generated code: output=c51b81c8de3fcc84 input=3924a233fae98adc]*/
SHA2N_OBJECT_UPDATE_IMPL_BODY(256, op, data)

/*[clinic input]
_sha2.sha384.update = _sha2.sha224.update
Update this hash object's state with the provided string.
[clinic start generated code]*/

static PyObject *
_sha2_sha384_update(PyObject *op, PyObject *data)
/*[clinic end generated code: output=9b446dae8df1c57d input=97600fcf46863a2c]*/
SHA2N_OBJECT_UPDATE_IMPL_BODY(384, op, data)

/*[clinic input]
_sha2.sha512.update = _sha2.sha224.update
Update this hash object's state with the provided string.
[clinic start generated code]*/

static PyObject *
_sha2_sha512_update(PyObject *op, PyObject *data)
/*[clinic end generated code: output=59b133f2ff16cd39 input=74ce6f09e5e76aed]*/
SHA2N_OBJECT_UPDATE_IMPL_BODY(512, op, data)
#undef SHA2N_OBJECT_UPDATE_IMPL_BODY

/* Compute the raw binary digest of a SHA-2 object. */
#define SHA2N_OBJECT_DIGEST_IMPL_BODY(N, SELF)                  \
    {                                                           \
        uint8_t digest[SHA2N_DIGEST_SIZE(N)];                   \
        HASHLIB_ACQUIRE_LOCK(SELF);                             \
        HACL_HASH_SHA2_(N, digest)((SELF)->state, digest);      \
        HASHLIB_RELEASE_LOCK(SELF);                             \
        return PyBytes_FromStringAndSize((const char *)digest,  \
                                         SHA2N_DIGEST_SIZE(N)); \
    }

/*[clinic input]
_sha2.sha224.digest
Return the digest value as a bytes object.
[clinic start generated code]*/

static PyObject *
_sha2_sha224_digest_impl(SHA2N_O(224) *self)
/*[clinic end generated code: output=5a0f7e48f8695c13 input=93ea2ea3a95e3b61]*/
SHA2N_OBJECT_DIGEST_IMPL_BODY(224, self)

/*[clinic input]
_sha2.sha256.digest
Return the digest value as a bytes object.
[clinic start generated code]*/

static PyObject *
_sha2_sha256_digest_impl(SHA2N_O(256) *self)
/*[clinic end generated code: output=32dd6ea4184960aa input=a8d49fc95711cf59]*/
SHA2N_OBJECT_DIGEST_IMPL_BODY(256, self)

/*[clinic input]
_sha2.sha384.digest
Return the digest value as a bytes object.
[clinic start generated code]*/

static PyObject *
_sha2_sha384_digest_impl(SHA2N_O(384) *self)
/*[clinic end generated code: output=cb4518480ed05a6b input=b0c88f92c1c410f6]*/
SHA2N_OBJECT_DIGEST_IMPL_BODY(384, self)

/*[clinic input]
_sha2.sha512.digest
Return the digest value as a bytes object.
[clinic start generated code]*/

static PyObject *
_sha2_sha512_digest_impl(SHA2N_O(512) *self)
/*[clinic end generated code: output=a923fedb863fb645 input=3f1c7acd439d8524]*/
SHA2N_OBJECT_DIGEST_IMPL_BODY(512, self)
#undef SHA2N_OBJECT_DIGEST_IMPL_BODY

/* Compute the hexadecimal representation of a SHA-2 digest. */
#define SHA2N_OBJECT_HEXDIGEST_IMPL_BODY(N, SELF)                       \
    {                                                                   \
        uint8_t digest[SHA2N_DIGEST_SIZE(N)];                           \
        HASHLIB_ACQUIRE_LOCK(SELF);                                     \
        HACL_HASH_SHA2_(N, digest)((SELF)->state, digest);              \
        HASHLIB_RELEASE_LOCK(SELF);                                     \
        return _Py_strhex((const char *)digest, SHA2N_DIGEST_SIZE(N));  \
    }

/*[clinic input]
_sha2.sha224.hexdigest

Return the digest value as a string of hexadecimal digits.
[clinic start generated code]*/

static PyObject *
_sha2_sha224_hexdigest_impl(SHA2N_O(224) *self)
/*[clinic end generated code: output=72658011aa3b635b input=ea7596919378aa81]*/
SHA2N_OBJECT_HEXDIGEST_IMPL_BODY(224, self)

/*[clinic input]
_sha2.sha256.hexdigest

Return the digest value as a string of hexadecimal digits.
[clinic start generated code]*/

static PyObject *
_sha2_sha256_hexdigest_impl(SHA2N_O(256) *self)
/*[clinic end generated code: output=b5c61a7ac62e4dd2 input=b5dc9ed1fb19ee00]*/
SHA2N_OBJECT_HEXDIGEST_IMPL_BODY(256, self)

/*[clinic input]
_sha2.sha384.hexdigest

Return the digest value as a string of hexadecimal digits.
[clinic start generated code]*/

static PyObject *
_sha2_sha384_hexdigest_impl(SHA2N_O(384) *self)
/*[clinic end generated code: output=a3c146a7daf87ff3 input=ca2fe324306d68a2]*/
SHA2N_OBJECT_HEXDIGEST_IMPL_BODY(384, self)

/*[clinic input]
_sha2.sha512.hexdigest

Return the digest value as a string of hexadecimal digits.
[clinic start generated code]*/

static PyObject *
_sha2_sha512_hexdigest_impl(SHA2N_O(512) *self)
/*[clinic end generated code: output=5b9f840530e770e4 input=8a2578fe8832a2d5]*/
SHA2N_OBJECT_HEXDIGEST_IMPL_BODY(512, self)
#undef SHA2N_OBJECT_HEXDIGEST_IMPL_BODY

// --- SHA-2 object: public getters -------------------------------------------

#define SHA2N_OBJECT_NAME_GETTER_DECL(N)                    \
    static inline PyObject *                                \
    SHA2N_GETTER(N, name) (PyObject *Py_UNUSED(op),         \
                           void *Py_UNUSED(closure))        \
    {                                                       \
        assert(strlen(#N) == 3);                            \
        return PyUnicode_FromStringAndSize("sha" #N, 6);    \
    }
SHA2_EXPAND_MACRO(SHA2N_OBJECT_NAME_GETTER_DECL)
#undef SHA2N_OBJECT_NAME_GETTER_DECL

#define SHA2N_OBJECT_BLOCK_SIZE_GETTER_DECL(N)              \
    static inline PyObject *                                \
    SHA2N_GETTER(N, block_size) (PyObject *Py_UNUSED(op),   \
                                 void *Py_UNUSED(closure))  \
    {                                                       \
        return PyLong_FromLong(SHA2N_BLOCK_SIZE(N));        \
    }
SHA2_EXPAND_MACRO(SHA2N_OBJECT_BLOCK_SIZE_GETTER_DECL)
#undef SHA2N_OBJECT_BLOCK_SIZE_GETTER_DECL

#define SHA2N_OBJECT_DIGEST_SIZE_GETTER_DECL(N)             \
    static inline PyObject *                                \
    SHA2N_GETTER(N, digest_size) (PyObject *Py_UNUSED(op),  \
                                  void *Py_UNUSED(closure)) \
    {                                                       \
        return PyLong_FromLong(SHA2N_DIGEST_SIZE(N));       \
    }
SHA2_EXPAND_MACRO(SHA2N_OBJECT_DIGEST_SIZE_GETTER_DECL)
#undef SHA2N_OBJECT_DIGEST_SIZE_GETTER_DECL

// --- SHA-2 type specifications ----------------------------------------------

#define SHA2N_TYPE_OBJECT_METHODS_DEF_DECL(N)               \
    static PyMethodDef SHA2N_TYPE_SLOT(N, methods)[] = {    \
        SHA2N_CLINIC(N, COPY_METHODDEF)                     \
        SHA2N_CLINIC(N, UPDATE_METHODDEF)                   \
        SHA2N_CLINIC(N, DIGEST_METHODDEF)                   \
        SHA2N_CLINIC(N, HEXDIGEST_METHODDEF)                \
        {NULL, NULL} /* sentinel */                         \
    };
SHA2_EXPAND_MACRO(SHA2N_TYPE_OBJECT_METHODS_DEF_DECL)
#undef SHA2N_TYPE_OBJECT_METHODS_DEF_DECL

#define SHA2N_TYPE_OBJECT_GETSETS_DEF_DECL(N)                       \
    static PyGetSetDef SHA2N_TYPE_SLOT(N, getsets)[] = {            \
        {"name", SHA2N_GETTER(N, name), NULL, NULL},                \
        {"block_size", SHA2N_GETTER(N, block_size), NULL, NULL},    \
        {"digest_size", SHA2N_GETTER(N, digest_size), NULL, NULL},  \
        {NULL} /* sentinel */                                       \
    };
SHA2_EXPAND_MACRO(SHA2N_TYPE_OBJECT_GETSETS_DEF_DECL)
#undef SHA2N_TYPE_OBJECT_GETSETS_DEF_DECL

#define SHA2N_TYPE_OBJECT_SLOTS_DECL(N)                 \
    static PyType_Slot SHA2N_TYPE_SLOT_ARRAY(N)[] = {   \
        {Py_tp_methods, SHA2N_TYPE_SLOT(N, methods)},   \
        {Py_tp_getset, SHA2N_TYPE_SLOT(N, getsets)},    \
        {Py_tp_dealloc, SHA2N_TYPE_SLOT(N, dealloc)},   \
        {Py_tp_traverse, SHA2N_TYPE_SLOT(N, traverse)}, \
        {0, NULL} /* sentinel */                        \
    };
SHA2_EXPAND_MACRO(SHA2N_TYPE_OBJECT_SLOTS_DECL)
#undef SHA2N_TYPE_OBJECT_SLOTS_DECL

// Using _PyType_GetModuleState() on these types is safe since they
// cannot be subclassed: they don't have the Py_TPFLAGS_BASETYPE flag.
#define SHA2N_TYPE_OBJECT_TYPE_SPEC_DECL(N)         \
    static PyType_Spec SHA2N_TYPE_SPEC(N) = {       \
        .name = "_sha2.SHA" Py_STRINGIFY(N) "Type", \
        .basicsize = sizeof(SHA2N_O(N)),            \
        .flags = (                                  \
              Py_TPFLAGS_DEFAULT                    \
            | Py_TPFLAGS_DISALLOW_INSTANTIATION     \
            | Py_TPFLAGS_IMMUTABLETYPE              \
            | Py_TPFLAGS_HAVE_GC                    \
        ),                                          \
        .slots = SHA2N_TYPE_SLOT_ARRAY(N)           \
    };
SHA2_EXPAND_MACRO(SHA2N_TYPE_OBJECT_TYPE_SPEC_DECL)
#undef SHA2N_TYPE_OBJECT_TYPE_SPEC_DECL

// --- SHA-2 module-level named constructors ----------------------------------

#define SHA2N_FACTORY_IMPL_BODY(N, MODULE, DATA, STRING, USEDFORSECURITY)   \
    {                                                                       \
        Py_buffer buf;                                                      \
        PyObject *msg;                                                      \
        /* TODO(picnixz): this should be removed in Python 3.19 */          \
        if (_Py_hashlib_data_argument(&msg, (DATA), (STRING)) < 0) {        \
            return NULL;                                                    \
        }                                                                   \
        if (msg) {                                                          \
            GET_BUFFER_VIEW_OR_ERROUT(msg, &buf);                           \
        }                                                                   \
        sha2module_state *state = get_sha2module_state((MODULE));           \
        SHA2N_O(N) *self = SHA2N_HELPER(N, new)(state);                     \
        if (self == NULL) {                                                 \
            if (msg) {                                                      \
                PyBuffer_Release(&buf);                                     \
            }                                                               \
            return NULL;                                                    \
        }                                                                   \
        self->state = HACL_HASH_SHA2_(N, malloc)();                         \
        if (self->state == NULL) {                                          \
            Py_DECREF(self);                                                \
            if (msg) {                                                      \
                PyBuffer_Release(&buf);                                     \
            }                                                               \
            return PyErr_NoMemory();                                        \
        }                                                                   \
        if (msg) {                                                          \
            /* Do not use self->mutex here as this is the constructor
             * where it is not yet possible to have concurrent access. */   \
            HASHLIB_EXTERNAL_INSTRUCTIONS_UNLOCKED(                         \
                buf.len,                                                    \
                SHA2N_HACL_SHA2_STATE_UPDATE_WITH_BUFFER(N, self, buf)      \
            );                                                              \
            PyBuffer_Release(&buf);                                         \
        }                                                                   \
        return (PyObject *)self;                                            \
    }

/*[clinic input]
_sha2.sha224

    data: object(c_default="NULL") = b''
    *
    usedforsecurity: bool = True
    string: object(c_default="NULL") = None

Return a new SHA-224 hash object; optionally initialized with a string.
[clinic start generated code]*/

static PyObject *
_sha2_sha224_impl(PyObject *module, PyObject *data, int usedforsecurity,
                  PyObject *string)
/*[clinic end generated code: output=e469eb87e6ff5796 input=16ae8ff74ba9ce03]*/
SHA2N_FACTORY_IMPL_BODY(224, module, data, string, usedforsecurity)

/*[clinic input]
_sha2.sha256 = _sha2.sha224

Return a new SHA-256 hash object; optionally initialized with a string.
[clinic start generated code]*/

static PyObject *
_sha2_sha256_impl(PyObject *module, PyObject *data, int usedforsecurity,
                  PyObject *string)
/*[clinic end generated code: output=5daec6e448d859b1 input=0f4bdbdf4f8d1be3]*/
SHA2N_FACTORY_IMPL_BODY(256, module, data, string, usedforsecurity)

/*[clinic input]
_sha2.sha384 = _sha2.sha224

Return a new SHA-384 hash object; optionally initialized with a string.
[clinic start generated code]*/

static PyObject *
_sha2_sha384_impl(PyObject *module, PyObject *data, int usedforsecurity,
                  PyObject *string)
/*[clinic end generated code: output=c4095e5c6974ee63 input=a01376739d75228b]*/
SHA2N_FACTORY_IMPL_BODY(384, module, data, string, usedforsecurity)

/*[clinic input]
_sha2.sha512 = _sha2.sha224

Return a new SHA-512 hash object; optionally initialized with a string.
[clinic start generated code]*/

static PyObject *
_sha2_sha512_impl(PyObject *module, PyObject *data, int usedforsecurity,
                  PyObject *string)
/*[clinic end generated code: output=c49020bd79bf4edc input=7366a3a246f48f29]*/
SHA2N_FACTORY_IMPL_BODY(512, module, data, string, usedforsecurity)
#undef SHA2N_FACTORY_IMPL_BODY

// --- SHA-2 module methods ---------------------------------------------------

static struct PyMethodDef sha2module_methods[] = {
    _SHA2_SHA256_METHODDEF
    _SHA2_SHA224_METHODDEF
    _SHA2_SHA512_METHODDEF
    _SHA2_SHA384_METHODDEF
    {NULL, NULL} /* sentinel */
};

// --- SHA-2 module initialization and finalization functions -----------------

static int
sha2module_traverse(PyObject *module, visitproc visit, void *arg)
{
    sha2module_state *state = get_sha2module_state(module);
    Py_VISIT(state->sha224_type);
    Py_VISIT(state->sha256_type);
    Py_VISIT(state->sha384_type);
    Py_VISIT(state->sha512_type);
    return 0;
}

static int
sha2module_clear(PyObject *module)
{
    sha2module_state *state = get_sha2module_state(module);
    Py_CLEAR(state->sha224_type);
    Py_CLEAR(state->sha256_type);
    Py_CLEAR(state->sha384_type);
    Py_CLEAR(state->sha512_type);
    return 0;
}

static void
sha2module_free(void *module)
{
    (void)sha2module_clear((PyObject *)module);
}

/* Initialize this module. */
static int
sha2module_exec(PyObject *module)
{
    sha2module_state *state = get_sha2module_state(module);
#define SHA2N_MAKE_TYPE(N)                                              \
    do {                                                                \
        state->SHA2N_T(N) = (PyTypeObject *)PyType_FromModuleAndSpec(   \
            module, &SHA2N_TYPE_SPEC(N), NULL);                         \
        if (state->SHA2N_T(N) == NULL) {                                \
            return -1;                                                  \
        }                                                               \
        if (PyModule_AddType(module, state->SHA2N_T(N)) < 0) {          \
            return -1;                                                  \
        }                                                               \
    } while (0)
    SHA2_EXPAND_MACRO(SHA2N_MAKE_TYPE)
#undef SHA2N_MAKE_TYPE

    if (PyModule_AddIntConstant(module,
                                "_GIL_MINSIZE",
                                HASHLIB_GIL_MINSIZE) < 0) {
        return -1;
    }

    return 0;
}

static PyModuleDef_Slot sha2module_slots[] = {
    {Py_mod_exec, sha2module_exec},
    {Py_mod_multiple_interpreters, Py_MOD_PER_INTERPRETER_GIL_SUPPORTED},
    {Py_mod_gil, Py_MOD_GIL_NOT_USED},
    {0, NULL}
};

static struct PyModuleDef sha2module_def = {
    PyModuleDef_HEAD_INIT,
    .m_name = "_sha2",
    .m_size = sizeof(sha2module_state),
    .m_methods = sha2module_methods,
    .m_slots = sha2module_slots,
    .m_traverse = sha2module_traverse,
    .m_clear = sha2module_clear,
    .m_free = sha2module_free
};

PyMODINIT_FUNC
PyInit__sha2(void)
{
    return PyModuleDef_Init(&sha2module_def);
}
