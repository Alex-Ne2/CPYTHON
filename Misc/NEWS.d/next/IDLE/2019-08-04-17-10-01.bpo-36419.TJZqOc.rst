Refactor autocomplete and improve testing.
