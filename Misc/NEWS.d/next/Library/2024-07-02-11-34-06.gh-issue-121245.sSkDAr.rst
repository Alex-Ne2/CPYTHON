Fix a bug in the handling of the command history of the new :term:`REPL` that
caused the history file to be wiped at REPL exit.  ``site.register_readline()``
helper was refactored to choose correct readline backend from the beginning.
Patch by Sergey B Kirpichev.
